name: Publish workflow
runs:
  using: "composite"
  steps:
    - name: Cargo publish (dry-run)
      shell: bash
      if: contains(github.event.pull_request.labels.*.name, 'cargo-publish-dry-run')
      env:
        CARGO_REGISTRY_TOKEN: Zy9HhJ02RJmg0GCrgLfaCVfU6IwDfhXD
      run: |
        curl -L --output kellnr-latest.zip "https://github.com/kellnr/kellnr/releases/download/v5.1.1/kellnr-x86_64-unknown-linux-gnu.zip"
        unzip kellnr-latest.zip -d ./kellnr
        (cd ./kellnr && ./kellnr) &

        cargo publish --index sparse+http://localhost:8000/api/v1/crates/ --token Zy9HhJ02RJmg0GCrgLfaCVfU6IwDfhXD -p serde_v8 
        cargo publish --index sparse+http://localhost:8000/api/v1/crates/ --token Zy9HhJ02RJmg0GCrgLfaCVfU6IwDfhXD -p deno_ops
        cargo publish --index sparse+http://localhost:8000/api/v1/crates/ --token Zy9HhJ02RJmg0GCrgLfaCVfU6IwDfhXD -p deno_core
    - name: Cargo publish
      shell: bash
      if: "!contains(github.event.pull_request.labels.*.name, 'cargo-publish-dry-run')"
      run: |
        cargo publish -p serde_v8
        cargo publish -p deno_ops
        cargo publish -p deno_core
    - name: Get tag version
      shell: bash
      id: get_tag_version
      run: echo TAG_VERSION=${GITHUB_REF/refs\/tags\//} >> "$GITHUB_OUTPUT"
