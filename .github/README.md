# Project CI Documentation

This repository uses GitHub Actions for continuous integration. The build process is organized into a series of jobs and workflows defined in YAML files within the `.github/workflows/` directory.

## Build Matrix

The build matrix is dynamically generated based on the repository and the nature of the workflow trigger. The primary matrix is defined in the `ci.yml` file. It considers the repository and the ref (tag or branch) to determine the appropriate set of jobs to execute.

### Matrix Generation Example

```json
{
  "matrix": [
    {
      "label": "linux",
      "os": "ubuntu-latest",
      "job": "lint"
    },
    {
      "label": "linux",
      "os": "ubuntu-latest",
      "job": "lint-deps"
    },
    {
      "label": "linux",
      "os": "ubuntu-latest",
      "job": "test"
    },
    /* ... */
  ]
}
```

### Workflow Descriptions

- **Main Builds:**
  - Trigger: Push to `main` branch
  - Matrix:
    - Generates a matrix of jobs for different operating systems (Linux, macOS, Windows)
    - Executes linting, testing, and other relevant tasks

- **Pull Requests:**
  - Trigger: Any pull request to `main` branch
  - Matrix:
    - Similar to main builds but runs on pull request events
    - Executes linting, testing, and other relevant tasks

- **Tag Builds:**
  - Trigger: Push to tags
  - Matrix:
    - 'nop' job
    - Executes the publish job on tagged releases

## Job Execution

The core job execution is orchestrated by the `ci.yml` workflow. Here is a high-level overview of the key jobs:

### 1. `compute-jobs`

This job computes the matrix for the subsequent jobs based on the repository and ref conditions. It reads the job configuration from embedded YAML and sets up the matrix for different OS and jobs.

The extracted configurations are transformed into a matrix structure, which includes the label (job name), operating system (OS), and specific job type.

### 2. `top`

This job is responsible for coordinating the execution of individual jobs defined in `ci-job.yml` based on the matrix generated by `compute-jobs`. It acts as the orchestrator for the overall CI workflow.

For each combination in the computed matrix, the `top` job calls the `ci-job.yml` workflow. It passes parameters such as label, OS, job, etc. to the `ci-job.yml`.

The `top` job triggers parallel executions of the `ci-job.yml` for each combination in the matrix.

### 3. Sub-Jobs (e.g., `lint`, `test`, `publish`)

Each sub-job is defined in the `ci-job.yml` file. These jobs perform specific tasks such as linting, testing, or publishing based on the matrix parameters. The job execution includes steps like cloning the repository, installing Rust and Deno, caching, and executing specific commands based on the job type.

### 4. `success`

A simple job that runs after the `top` job is successful. It prints a success message indicating that the CI workflow has completed successfully. This allows us to have a single "build success" step for the repository.

## Sub-Job Descriptions

- **`ci-lint*.yml`**: Lints the code using various linting tools for Rust and Deno.
- **`ci-test*.yml`**: Runs linting and testing tasks for the project.
- **`ci-test-publish.yml`**: Tests the publish process in a dry-run mode.
- **`ci-publish.yml`**: Publishes the project, triggered only on tag events.
